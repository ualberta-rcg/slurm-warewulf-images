name: Build, Scan, and Remediate CIS Image

on:
  push:
    branches-ignore:
      - main
      - compliance-reports

jobs:
  build-scan-remediate:
    runs-on: ubuntu-latest

    env:
      DOCKER_REPO: rkhoja/slurm-node

    steps:
      - name: 🛠️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🐳 Set OS-Specific Directory
        id: os_dir
        run: echo "os_dir=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: 🐳 Build Docker Image
        run: |
          docker build -t $DOCKER_REPO:${GITHUB_REF_NAME} ./${GITHUB_REF_NAME}

      - name: 🛡️ Run OpenSCAP Scan
        run: |
          docker run --privileged --name openscap-scan $DOCKER_REPO:${GITHUB_REF_NAME} /openscap_scan.sh

      - name: 📤 Extract Scan Report
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          mv oscap-results.html oscap-results-${TIMESTAMP}.html
          mv oscap-results.xml oscap-results-${TIMESTAMP}.xml
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: 🔧 Run OpenSCAP Remediation
        run: |
          docker commit openscap-scan $DOCKER_REPO:${GITHUB_REF_NAME}-remediated
          docker run --privileged --name openscap-remediate $DOCKER_REPO:${GITHUB_REF_NAME}-remediated /openscap_remediate.sh

      - name: 📤 Extract Remediation Report
        run: |
          mv oscap-results-remediated.html oscap-results-remediated-${{ env.TIMESTAMP }}.html

      - name: 📊 Upload Compliance Reports as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: openscap-reports-${{ github.ref_name }}
          path: |
            oscap-results-${{ env.TIMESTAMP }}.html
            oscap-results-${{ env.TIMESTAMP }}.xml
            oscap-results-remediated-${{ env.TIMESTAMP }}.html

      - name: 🚀 Commit and Push Compliance Reports
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Fetch all branches and switch to compliance-reports
          git fetch origin
          if ! git show-ref --quiet refs/heads/compliance-reports; then
            git checkout --orphan compliance-reports
            git rm -rf .
          else
            git checkout compliance-reports
            git pull origin compliance-reports --rebase
          fi

          # Create a branch-specific folder for reports
          mkdir -p reports/${{ github.ref_name }}
          mv oscap-results-${{ env.TIMESTAMP }}.html reports/${{ github.ref_name }}/oscap-results-${{ env.TIMESTAMP }}.html
          mv oscap-results-${{ env.TIMESTAMP }}.xml reports/${{ github.ref_name }}/oscap-results-${{ env.TIMESTAMP }}.xml
          mv oscap-results-remediated-${{ env.TIMESTAMP }}.html reports/${{ github.ref_name }}/oscap-results-remediated-${{ env.TIMESTAMP }}.html

          # Commit and push reports
          git add reports/
          if git diff --cached --quiet; then
            echo "No changes to commit in compliance reports."
          else
            git commit -m "Add OpenSCAP compliance reports for branch ${{ github.ref_name }} at ${{ env.TIMESTAMP }}"
            git push -f origin compliance-reports
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🚀 Push Remediated Docker Image
        run: |
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USER }}" --password-stdin
          docker tag $DOCKER_REPO:${GITHUB_REF_NAME}-remediated $DOCKER_REPO:${GITHUB_REF_NAME}
          docker push $DOCKER_REPO:${GITHUB_REF_NAME}
